@{
    ViewData["Title"] = "Home";
}
<style>
    @@media only screen and (min-width: 768px) {
  .table-responsive {
    overflow-x: hidden;
  }
}
    #tableOrder thead{
        display:none !important;
    }
</style>
<!--begin::Content-->
<div class="content d-flex flex-column flex-column-fluid" id="kt_content">
    <!--begin::Subheader-->
    <div class="subheader py-2 py-lg-4 subheader-solid" id="kt_subheader">
        <div class="container-fluid d-flex align-items-center justify-content-between flex-wrap flex-sm-nowrap">
            <!--begin::Info-->
            <div class="d-flex align-items-center flex-wrap mr-2">
                <!--begin::Page Title-->
                <h5 class="text-dark font-weight-bold mt-2 mb-2 mr-5">Dashboard</h5>
                <!--end::Page Title-->
                <!--begin::Actions-->
                <!--end::Actions-->
            </div>
            <!--end::Info-->
        </div>
    </div>
    <!--end::Subheader-->
    <!--begin::Entry-->
    <div class="d-flex flex-column-fluid">
        <!--begin::Container-->
        <div class="container">
            <!--begin::Dashboard-->
            <!--begin::Row-->
            <div class="row">
                <div class="col-lg-6 col-xxl-6">
                    <!--begin::Mixed Widget 14-->
                    <div class="card card-custom card-stretch gutter-b">
                        <!--begin::Header-->
                        <div class="card-header border-0 pt-5">
                            <h3 class="card-title font-weight-bolder">Order Stats</h3>
                        </div>
                        <!--end::Header-->
                        <!--begin::Body-->
                        <div class="card-body d-flex flex-column">
                            <div class="flex-grow-1">
                                <div id="chart_13" style="height: 180px"></div>
                            </div>
                            <div class="pt-2">
                                <p class="text-center font-weight-normal font-size-lg pb-7">
                                    Total Orders stats with thier status
                                </p>
                            </div>
                        </div>
                        <!--end::Body-->
                    </div>
                    <!--end::Mixed Widget 14-->
                    <!--end::Mixed Widget 1-->
                </div>
                <div class="col-lg-6 col-xxl-6">
                    <!--begin::Stats Widget 11-->
                    <div class="card card-custom card-stretch card-stretch-half gutter-b">
                        <!--begin::Body-->
                        <div class="card-body p-0">
                            <div class="d-flex align-items-center justify-content-between card-spacer flex-grow-1">
                                <span class="symbol symbol-50 symbol-light-success mr-2">
                                    <span class="symbol-label">
                                        <span class="svg-icon svg-icon-xl svg-icon-success">
                                            <!--begin::Svg Icon | path:assets/media/svg/icons/Layout/Layout-4-blocks.svg-->
                                            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                                                <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                                    <rect x="0" y="0" width="24" height="24" />
                                                    <rect fill="#000000" x="4" y="4" width="7" height="7" rx="1.5" />
                                                    <path d="M5.5,13 L9.5,13 C10.3284271,13 11,13.6715729 11,14.5 L11,18.5 C11,19.3284271 10.3284271,20 9.5,20 L5.5,20 C4.67157288,20 4,19.3284271 4,18.5 L4,14.5 C4,13.6715729 4.67157288,13 5.5,13 Z M14.5,4 L18.5,4 C19.3284271,4 20,4.67157288 20,5.5 L20,9.5 C20,10.3284271 19.3284271,11 18.5,11 L14.5,11 C13.6715729,11 13,10.3284271 13,9.5 L13,5.5 C13,4.67157288 13.6715729,4 14.5,4 Z M14.5,13 L18.5,13 C19.3284271,13 20,13.6715729 20,14.5 L20,18.5 C20,19.3284271 19.3284271,20 18.5,20 L14.5,20 C13.6715729,20 13,19.3284271 13,18.5 L13,14.5 C13,13.6715729 13.6715729,13 14.5,13 Z" fill="#000000" opacity="0.3" />
                                                </g>
                                            </svg>
                                            <!--end::Svg Icon-->
                                        </span>
                                    </span>
                                </span>
                                <div class="d-flex flex-column text-right">
                                    <span class="text-dark-75 font-weight-bolder font-size-h3" id="totalRevenue">750 &#8377;</span>
                                    <span class="text-muted font-weight-bold mt-2">Total Revenue</span>
                                </div>
                            </div>
                            <div id="kt_stats_widget_11_chart" class="card-rounded-bottom" data-color="success" style="height: 150px"></div>
                        </div>
                        <!--end::Body-->
                    </div>
                    <!--end::Stats Widget 11-->
                    <!--begin::Stats Widget 12-->
                    <div class="card card-custom card-stretch card-stretch-half gutter-b">
                        <!--begin::Body-->
                        <div class="card-body p-0">
                            <div class="d-flex align-items-center justify-content-between card-spacer flex-grow-1">
                                <span class="symbol symbol-50 symbol-light-primary mr-2">
                                    <span class="symbol-label">
                                        <span class="svg-icon svg-icon-xl svg-icon-primary">
                                            <!--begin::Svg Icon | path:assets/media/svg/icons/Communication/Group.svg-->
                                            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                                                <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                                    <polygon points="0 0 24 0 24 24 0 24" />
                                                    <path d="M18,14 C16.3431458,14 15,12.6568542 15,11 C15,9.34314575 16.3431458,8 18,8 C19.6568542,8 21,9.34314575 21,11 C21,12.6568542 19.6568542,14 18,14 Z M9,11 C6.790861,11 5,9.209139 5,7 C5,4.790861 6.790861,3 9,3 C11.209139,3 13,4.790861 13,7 C13,9.209139 11.209139,11 9,11 Z" fill="#000000" fill-rule="nonzero" opacity="0.3" />
                                                    <path d="M17.6011961,15.0006174 C21.0077043,15.0378534 23.7891749,16.7601418 23.9984937,20.4 C24.0069246,20.5466056 23.9984937,21 23.4559499,21 L19.6,21 C19.6,18.7490654 18.8562935,16.6718327 17.6011961,15.0006174 Z M0.00065168429,20.1992055 C0.388258525,15.4265159 4.26191235,13 8.98334134,13 C13.7712164,13 17.7048837,15.2931929 17.9979143,20.2 C18.0095879,20.3954741 17.9979143,21 17.2466999,21 C13.541124,21 8.03472472,21 0.727502227,21 C0.476712155,21 -0.0204617505,20.45918 0.00065168429,20.1992055 Z" fill="#000000" fill-rule="nonzero" />
                                                </g>
                                            </svg>
                                            <!--end::Svg Icon-->
                                        </span>
                                    </span>
                                </span>
                                <div class="d-flex flex-column text-right">
                                    <span class="text-dark-75 font-weight-bolder font-size-h3" id="totalOrders">+6</span>
                                    <span class="text-muted font-weight-bold mt-2">Total Orders</span>
                                </div>
                            </div>
                            <div id="kt_stats_widget_12_chart" class="card-rounded-bottom" data-color="primary" style="height: 150px"></div>
                        </div>
                        <!--end::Body-->
                    </div>
                    <!--end::Stats Widget 12-->
                </div>


            </div>
            <!--end::Row-->
            <!--begin::Row-->
            <div class="row">
                <div class="col-lg-12 col-xxl-12 order-2 order-xxl-1">
                    <!--begin::Advance Table Widget 2-->
                    <div class="card card-custom card-stretch gutter-b">
                        <!--begin::Header-->
                        <div class="card-header border-0 pt-5">
                            <h3 class="card-title align-items-start flex-column">
                                <span class="card-label font-weight-bolder text-dark">New Orders</span>
                                <span class="text-muted mt-3 font-weight-bold font-size-sm">Order to pickup and arrive at station</span>
                            </h3>
                        </div>
                        <!--end::Header-->
                        <!--begin::Body-->
                        <div class="card-body pt-2 pb-0 mt-n3">
                            <div class="tab-content mt-5" id="myTabTables11">
                                <!--begin::Tap pane-->
                                <div class="tab-pane fade show active" id="kt_tab_pane_11_1" role="tabpanel" aria-labelledby="kt_tab_pane_11_1">
                                    <!--begin::Table-->
                                    <div class="table-responsive">
                                        <table class="table table-borderless table-vertical-center" id="tableOrder">
                                            <thead>
                                            </thead>
                                            <tbody>
                                            </tbody>
                                        </table>
                                    </div>
                                    <!--end::Table-->
                                </div>
                                <!--end::Tap pane-->
                            </div>
                        </div>
                        <!--end::Body-->
                    </div>
                    <!--end::Advance Table Widget 2-->
                </div>
            </div>
            <!--end::Row-->
            <!--end::Dashboard-->
        </div>
        <!--end::Container-->
    </div>
    <!--end::Entry-->
</div>
<!--end::Content-->
@section scripts{ 
    <script>
        var isAdmin = '@User.IsInRole("Admin")';

        // Shared Colors Definition
        const primary = '#6993FF';
        const success = '#1BC5BD';
        const info = '#8950FC';
        const warning = '#FFA800';
        const danger = '#F64E60';
        var statChart;
        var orderCountByStatus = [];


               


        function getStatus(status) {
            if (status == 1) {
                return "<span class='label label-lg label-light-danger label-inline'>Booked</span>";
            } else if (status == 2) {
                return "<span class='label label-lg label-light-warning label-inline'>Picked Up</span>";
            } else if (status == 3) {
                return "<span class='label label-lg label-light-info label-inline'>In Transit</span>";
            } else if (status == 4) {
                return "<span class='label label-lg label-light-primary label-inline'>At Destination</span>";
            } else if (status == 5) {
                return "<span class='label label-lg label-light-success label-inline'>Delivered</span>";
            }
        }
        function getStatusName(status) {
            if (status == 1) {
                return "Booked";
            } else if (status == 2) {
                return "Picked Up";
            } else if (status == 3) {
                return "In Transit";
            } else if (status == 4) {
                return "At Destination";
            } else if (status == 5) {
                return "Delivered";
            }
        }

        var tableOrderOptions =  {
            ajax: {
                url: "order/GetOrderForDashboard",
                method: "GET",
                dataSrc: ''
            }, searching: false, paging: false, info: false,
            columns: [
                {
                    className: "pl-0",
                    render: function (data, type, row) {
                        var cell = "<a class='text-dark-75 font-weight-bolder text-hover-primary mb-1 font-size-lg'>" + row.recipientName + "</a>";
                        cell +="<div><span class='font-weight-bolder'>Phone: </span>";
                        cell += "<a class='text-muted font-weight-bold text-hover-primary'>" + row.recipientMobileNo + "</a></div>";
                        return cell;
                    }
                },
                {
                    className: "text-right",
                    render: function (data, type, row) {
                        var cell = "<span class='text-muted font-weight-500'>" + row.trackingId+"</span>";
                        return cell;
                    }
                },
                {
                    className: "text-right",
                    render: function (data, type, row) {
                        var cell = "<span class='text-muted font-weight-500'>" + row.recpientStation + "</span>";
                        return cell;
                    }
                },
                {
                    className: "text-right",
                    render: function (data, type, row) {
                        return getStatus(row.status);
                    }
                },
                {
                    className: "text-right pr-0",
                    render: function (data, type, row) {
                        var cell = "";
                        if (row.status < 5) {
                            if (row.status > 1) {
                                cell += "<a class='m-1 btn btn-icon btn-light btn-hover-warning btn-sm btnStatusBack' title='Set to " + getStatusName(row.status - 1) + "' record-id='" + row.id + "'><i class='fas fa-arrow-left'></i></a>";
                            }
                            cell += "<a class='m-1 btn btn-icon btn-light btn-hover-success btn-sm btnStatusAhead' title='Set to " + getStatusName(row.status - 1) + "' record-id='" + row.id + "'><i class='fas fa-arrow-right'></i></a>";
                            if (isAdmin == "True") {
                                cell += "<a class='m-1 btn btn-icon btn-light btn-hover-danger btn-sm btnDelete' record-id='" + row.id + "'><i class='fas fa-trash-alt'></i></a>";
                            }
                        }
                        return cell;
                    }
                }
            ],
        }
        var KtTable = $("#tableOrder").DataTable(tableOrderOptions);

        $(document).on("click", ".btnStatusBack", function () {
            var btn = $(this);
            $.ajax({
                url: "order/UpdateStatus?id=" + btn.attr("record-id") + "&type=b",
                type: "GET",
                success: function (data) {
                    toastr.success("Updated to " + getStatusName(parseInt(data)));
                    KtTable.ajax.reload();
                },
                error: function (err) {
                    toastr.error("Error: " + err.responseText);
                },
            });
        });

        $(document).on("click", ".btnStatusAhead", function () {
            var btn = $(this);
            $.ajax({
                url: "order/UpdateStatus?id=" + btn.attr("record-id") + "&type=f",
                type: "GET",
                success: function (data) {
                    toastr.success("Updated to " + getStatusName(parseInt(data)));
                    KtTable.ajax.reload();
                },
                error: function (err) {
                    toastr.error("Error: " + err.responseText);
                },
            });
        });

        $(document).on("click", ".btnDelete", function () {
            var btn = $(this);
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: "order/DeleteOrders?id=" + btn.attr("record-id"),
                        method: "DELETE",
                        success: function () {
                            console.log("success");
                            Swal.fire(
                                'Deleted!',
                                'Your file has been deleted.',
                                'success'
                            );
                            KtTable.ajax.reload();
                        },
                        error: function () {
                            console.log("error");
                            Swal.fire(
                                'Oops!',
                                'Something went wrong.',
                                'error'
                            )
                        }
                    });
                }
            })
        });


        function SetDashboardStats() {
            $.ajax({
                url: "../../backend/GetDashboardStats",
                type: "GET",
                success: function (data) {
                    console.log(data);
                    $("#totalOrders").text(" +"+data.totalOrders);
                    $("#totalRevenue").text(data.totalRevenue.toFixed(2) +" ₹");
                    orderCountByStatus = data.orderCountByStatus.map(Number);

                    var RadialChartOptions = {
                        series: orderCountByStatus,
                        chart: {
                            height: 350,
                            type: 'radialBar',
                        },
                        plotOptions: {
                            radialBar: {
                                dataLabels: {
                                    name: {
                                        fontSize: '22px',
                                    },
                                    value: {
                                        fontSize: '16px',
                                    },
                                    total: {
                                        show: true,
                                        label: 'Total',
                                        formatter: function (w) {
                                            // By default this function returns the average of all series. The below is just an example to show the use of custom formatter function
                                            return orderCountByStatus.reduce((a, b) => a + b);
                                        }
                                    }
                                }
                            }
                        },
                        labels: ['Booked', 'Picked Up', 'In Transit', 'At Destination', 'Delivered'],
                        colors: [primary, success, warning, danger, info]
                    };

                    statChart = new ApexCharts(document.querySelector("#chart_13"), RadialChartOptions);
                    statChart.render();
                }
            })
        }

        $(document).ready(function () {
            SetDashboardStats();
        })
    </script>
}